<!-- src/app/features/dashboard/dashboard/dashboard.component.html -->
<div class="dashboard-container">
  <h1>Tableau de Bord</h1>

  <div class="dashboard-grid">
    <!-- Section pour les médicaments proches de la rupture -->
    <div class="dashboard-card">
      <h2> Médicaments proches de la rupture</h2>
      <!-- On utilise notre nouvel observable avec le pipe async -->
      <div *ngIf="lowStockMedicines$ | async as lowStockMeds; else loadingAlerts">
        <ul *ngIf="lowStockMeds.length > 0; else noAlerts">
          <li *ngFor="let med of lowStockMeds">
            <strong>{{ med.name }}</strong> - Stock restant : {{ med.quantity }}
          </li>
        </ul>
        <ng-template #noAlerts>
          <p>Aucun médicament en rupture de stock. Excellent travail !</p>
        </ng-template>
      </div>
      <ng-template #loadingAlerts>
        <p>Chargement des alertes...</p>
      </ng-template>
    </div>

    <!-- Carte pour le chiffre d'affaires -->
    <div class="dashboard-card">
    <h2>Chiffre d'affaires du jour</h2>
    <!-- On utilise le pipe async et le pipe 'currency' pour formater le montant -->
    <p class="stat-value">
        {{ dailyRevenue$ | async | currency:'XOF':'symbol':'1.0-0' }}
    </p>
    </div>

    <!-- Carte pour le nombre de ventes -->
    <div class="dashboard-card">
    <h2>Nombre de ventes du jour</h2>
    <!-- On utilise simplement le pipe async -->
    <p class="stat-value">
        {{ dailySalesCount$ | async }}
    </p>
    </div>

    <div class="dashboard-card chart-card">
    <h2>Ventes de la semaine</h2>

    <!-- 
        On ajoute une condition *ngIf.
        Le graphique ne sera ajouté au DOM que si 'salesChartData' existe ET a une longueur > 0.
        Cela empêche le premier rendu "à vide" qui causait l'erreur.
    -->
    <div *ngIf="salesChartData && salesChartData.length > 0" style="height: 400px;">
        <ngx-charts-bar-vertical
        [results]="salesChartData"
        [xAxis]="true"
        [yAxis]="true"
        [legend]="false"
        [showXAxisLabel]="true"
        [showYAxisLabel]="true"
        xAxisLabel="Jour"
        yAxisLabel="Chiffre d'affaires (FCFA)">
        </ngx-charts-bar-vertical>
    </div>

    <!-- On peut même ajouter un message de chargement -->
    <div *ngIf="!salesChartData || salesChartData.length === 0">
        <p>Calcul des statistiques...</p>
    </div>
    </div>

  </div>
</div>
